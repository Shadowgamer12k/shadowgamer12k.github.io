<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bedrock Addon Tracker (Core)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --mc-bg: #48494a;
            --mc-panel: #313233;
            --mc-border-light: #5b5b5b;
            --mc-border-dark: #1e1e1f;
            --mc-green: #42b74f;
            --mc-blue: #5555ff;
            --mc-red: #ff5555;
            --mc-yellow: #fcfc00;
            --mc-purple: #b266ff;
            --mc-text: #ffffff;
            --mc-orange: #e67e22;
        }

        body {
            background-color: #1a1a1a;
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://assets.codepen.io/13471/dirt-bg.jpg');
            color: var(--mc-text);
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            line-height: 1.5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            background-color: var(--mc-bg);
            border: 4px solid #000;
            outline: 4px solid var(--mc-border-light);
            padding: 20px;
            box-shadow: 10px 10px 0 #000;
            position: relative;
        }

        /* Header */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 3px solid var(--mc-border-dark);
            padding-bottom: 20px;
        }

        h1 { 
            color: var(--mc-yellow); 
            font-size: 1.5rem; 
            text-shadow: 3px 3px #000;
            margin: 0;
            text-transform: uppercase;
        }

        .header-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .date-display { font-size: 0.7rem; color: #aaa; }
        .streak-display { color: var(--mc-orange); font-size: 0.7rem; text-shadow: 2px 2px #000; }

        h2 {
            font-size: 1rem;
            text-shadow: 2px 2px #000;
            margin: 30px 0 15px 0;
            border-bottom: 2px solid #555;
            padding-bottom: 5px;
        }

        /* Stats Grid */
        .stats-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px;
            background: #262626; padding: 20px;
            border: 3px solid var(--mc-border-dark); border-bottom: 3px solid var(--mc-border-light);
            margin-bottom: 25px; align-items: start;
        }

        .stat-box {
            text-align: center;
            background: rgba(0,0,0,0.2);
            padding: 10px 5px;
            border: 1px solid #444;
        }
        
        .stat-box div:first-child {
            color: #aaa; margin-bottom: 8px; font-size: 0.5rem; text-transform: uppercase; letter-spacing: 1px;
        }
        
        .stat-box input {
            background: transparent; border: none; color: var(--mc-green);
            font-family: 'Press Start 2P'; font-size: 0.8rem;
            width: 100%; text-align: center;
        }

        .val-green { color: #55ff55; font-size: 0.8rem; }
        .val-yellow { color: #ffff55; font-size: 0.8rem; }
        .val-blue { color: #5555ff; font-size: 0.8rem; }
        .val-purple { color: #ff55ff; font-size: 0.8rem; }
        .val-red { color: #ff5555; font-size: 0.8rem; }

        .action-btn {
            background: #555; border: 2px solid #000; color: white;
            font-family: 'Press Start 2P'; font-size: 0.6rem;
            padding: 5px 10px; cursor: pointer; margin-left: 5px;
        }
        .action-btn:hover { background: #777; }
        
        .log-input-group {
            display: flex;
            flex-direction: column; gap: 5px; align-items: center;
        }
        .note-input {
            background: #222; border: 2px solid #555; color: #fff;
            font-family: 'Press Start 2P', cursive; font-size: 0.5rem;
            padding: 3px; width: 90%; text-align: center;
        }

        /* Graph */
        .chart-container {
            background: #222; border: 3px solid var(--mc-border-dark);
            border-bottom: 3px solid var(--mc-border-light);
            padding: 10px; margin-bottom: 10px; position: relative;
        }
        canvas { width: 100%; height: 350px; display: block; }
        .chart-legend { display: flex; justify-content: center; gap: 20px; font-size: 0.6rem; margin-top: 5px; color: #aaa; }
        .legend-item span { display: inline-block; width: 10px; height: 10px; margin-right: 5px; border: 1px solid #000; }

        /* Tables */
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 0.7rem;
            margin-bottom: 30px; background: #222; border: 2px solid var(--mc-border-dark);
        }
        .data-table th { background: #333; padding: 10px; text-align: left; color: #aaa; }
        .data-table td { padding: 10px; border-bottom: 1px solid #444; }
        .data-table tr:hover { background: #2a2a2a; }
        .delete-btn { color: #ff5555; cursor: pointer; text-decoration: underline; }

        /* Groups */
        .reference-box {
            background: rgba(0,0,0,0.3); padding: 15px; font-size: 0.7rem;
            margin-bottom: 25px; border: 3px solid var(--mc-border-dark);
            line-height: 1.8; position: relative;
        }
        .edit-groups-btn {
            position: absolute; top: 10px; right: 10px;
            background: #555; color: #fff; border: 1px solid #000;
            font-family: 'Press Start 2P'; font-size: 0.5rem; padding: 5px; cursor: pointer;
        }
        .group-block { margin-bottom: 15px; border-left: 2px solid #555; padding-left: 10px; }
        .project-row-display {
            display: flex; justify-content: space-between; font-size: 0.6rem;
            color: #ddd; border-bottom: 1px solid #333; padding: 2px 0;
        }
        .growth-indicator { color: var(--mc-green); font-size: 0.5rem; margin-left: 5px; }

        /* Weekly Grid */
        .week-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .day-card { background-color: var(--mc-panel); border: 3px solid var(--mc-border-dark); padding: 15px; }
        .day-title { color: #d1d1d1; border-bottom: 3px solid #555; padding-bottom: 8px; margin-bottom: 15px; font-size: 0.8rem; text-align: center; }
        .task-item { display: flex; align-items: flex-start; margin-bottom: 12px; cursor: pointer; font-size: 0.65rem; }
        .task-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mc-checkbox { min-width: 16px; min-height: 16px; background: #000; border: 2px solid #666; margin-right: 10px; display: flex; align-items: center; justify-content: center; }
        .task-item.completed .mc-checkbox::after { content: ''; width: 8px; height: 8px; background-color: var(--mc-green); display: block; }
        .btn { background-color: #7d7d7d; border: 3px solid #000; color: #fff; font-family: 'Press Start 2P'; font-size: 0.9rem; padding: 15px 20px; cursor: pointer; width: 100%; margin-top: 30px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-box { background: var(--mc-bg); border: 4px solid white; outline: 4px solid black; padding: 30px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { color: var(--mc-yellow); margin-bottom: 20px; font-size: 1.2rem; }
        .modal-input { background: #222; border: 2px solid #555; color: white; font-family: 'Press Start 2P'; font-size: 1rem; padding: 10px; width: 100px; text-align: center; display: block; margin: 10px auto; }
        .modal-btn { background: var(--mc-green); border: 2px solid #000; color: white; font-family: 'Press Start 2P'; padding: 15px 30px; cursor: pointer; }
        #cfPasteModal { z-index: 2000 !important; }

        .project-edit-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .proj-name-input { background: #111; border: 1px solid #555; color: white; font-family: 'Press Start 2P'; font-size: 0.6rem; padding: 5px; flex-grow: 1; }
        .proj-dl-input { background: #111; border: 1px solid #555; color: var(--mc-green); font-family: 'Press Start 2P'; font-size: 0.6rem; padding: 5px; width: 60px; text-align: right; }
        .proj-del-btn { background: var(--mc-red); color: white; border: 1px solid #000; cursor: pointer; padding: 5px; font-size: 0.6rem; }
        .stat-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.8rem; color: #ddd; }
        .stat-input-row input { width: 100px; padding: 5px; background: #111; border: 1px solid #555; color: white; font-family: 'Press Start 2P'; text-align: right; }
        
        .rev-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .rev-input { background: #111; border: 1px solid #555; color: var(--mc-green); font-family: 'Press Start 2P'; font-size: 0.7rem; width: 80px; text-align: right; }
        .paste-textarea { width: 100%; height: 200px; background: #000; color: #0f0; border: 2px solid #555; font-family: monospace; font-size: 0.6rem; padding: 10px; box-sizing: border-box; resize: vertical; }
        .add-proj-btn { background: #333; color: #aaa; border: 1px dashed #666; width: 100%; font-size: 0.6rem; padding: 5px; cursor: pointer; margin-top: 5px; }
    </style>
</head>
<body>

    <!-- NEW DAY MODAL -->
    <div id="newDayModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">NEW DAY DETECTED!</div>
            <p style="font-size:0.8rem; line-height:1.6">Enter today's CurseForge points:</p>
            <input type="number" id="dailyPointsInput" class="modal-input" placeholder="0">
            <input type="text" id="dailyNoteInput" class="modal-input" style="font-size:0.8rem; width:200px;" placeholder="Optional Note">
            <button class="modal-btn" onclick="confirmDailyPoints()">CONFIRM</button>
        </div>
    </div>

    <div id="weeklyAuditModal" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--mc-red);">
            <div class="modal-title" style="color:var(--mc-red);">‚ö†Ô∏è WEEKLY PROJECT CHECK</div>
            <p style="font-size:0.6rem; color:#aaa; margin-bottom:20px;">You must update the TOTAL DOWNLOADS for every project.<br>Check your CurseForge Dashboard!</p>
            <div id="auditContainer" style="text-align: left;"></div>
            <button class="modal-btn" style="background:var(--mc-red); margin-top:20px;" onclick="confirmAudit()">UPDATE ALL STATS</button>
        </div>
    </div>

    <div id="revenueHubModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="color:var(--mc-green);">REVENUE HUB</div>
            <p style="font-size:0.6rem; color:#aaa; margin-bottom:20px;">External Earnings for Today</p>
            <div id="revSourcesContainer"></div>
            <div class="rev-row" style="margin-top:10px;">
                <span style="color:var(--mc-yellow)">CurseForge Est:</span>
                <span id="revHubCF">$0.00</span>
            </div>
            <div style="font-size:1rem; margin-top:20px; color:var(--mc-green)">
                TOTAL: $<span id="revHubTotal">0.00</span>
            </div>
            <button class="modal-btn" style="margin-top:20px;" onclick="saveRevenueHub()">SAVE & CLOSE</button>
            <button class="action-btn" style="background:#444; margin-top:10px;" onclick="addRevenueSource()">+ ADD SOURCE</button>
        </div>
    </div>

    <div id="cfPasteModal" class="modal-overlay">
        <div class="modal-box" style="max-width:700px;">
            <div class="modal-title" style="color:var(--mc-blue);">IMPORT CF DATA</div>
            <button class="action-btn" style="background:var(--mc-orange); margin-bottom:10px;" onclick="copyScraperScript()">[COPY CONSOLE SCRIPT]</button>
            <p style="font-size:0.6rem; color:#aaa; margin-bottom:10px;">Paste the array [...] from the console script below:</p>
            <textarea id="cfPasteArea" class="paste-textarea" placeholder='[{"name":"Project A","downloads":100} ...]'></textarea>
            <div style="margin-top:15px;">
                <button class="modal-btn" onclick="processCFPaste()">LOAD DATA</button>
                <button class="action-btn" style="background:#444;" onclick="document.getElementById('cfPasteModal').style.display='none'">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="editGroupsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">MANAGE PROJECTS</div>
            <div id="groupEditContainer"></div>
            <button class="modal-btn" onclick="saveGroups()">SAVE CHANGES</button>
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <button class="action-btn" style="background:#5555ff;" onclick="openCFPasteModal()">[PASTE CF DATA]</button>
                <button class="action-btn" style="background:#444;" onclick="document.getElementById('editGroupsModal').style.display='none'">CANCEL</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-section">
            <div style="display:flex; flex-direction:column;">
                <h1>Road To $200</h1>
            </div>
            <div class="header-right">
                <div class="date-display" id="clockDisplay">Loading...</div>
                <div class="streak-display">üî• STREAK: <span id="streakValue">0</span> DAYS</div>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-box">
                <div>$/Pt Rate</div>
                <input type="number" id="pointRate" value="0.05" class="rate-input" step="0.01" onchange="updateRevenue()">
            </div>
            <div class="stat-box">
                <div>Daily Goal</div>
                <input type="number" id="goalPoints" value="120" class="goal-input" onchange="saveGoal()">
            </div>
            <div class="stat-box" style="flex-grow:2;">
                <div>Log Pts</div>
                <div class="log-input-group">
                    <input type="number" id="currentPoints" value="18" onchange="updateRevenue()">
                    <input type="text" id="logNote" class="note-input" placeholder="Note">
                    <button class="action-btn" onclick="logPoints()">LOG</button>
                </div>
            </div>
            <div class="stat-box" style="cursor:pointer; border:1px solid var(--mc-green);" onclick="openRevenueHub()">
                <div>Daily $</div>
                <div class="val-green">$<span id="revenueDisplay">0.00</span></div>
            </div>
            <div class="stat-box">
                <div>Last 7 Days</div>
                <div class="val-blue">$<span id="last7TotalDisplay">0.00</span> <span id="mom7"></span></div>
            </div>
            <div class="stat-box">
                <div>Lifetime $</div>
                <div class="val-purple">$<span id="lifetimeDisplay">0.00</span></div>
            </div>
            <div class="stat-box">
                <div>7-Day Avg</div>
                <div class="val-yellow">$<span id="avg7DayDisplay">0.00</span></div>
            </div>
        </div>

        <!-- Graph -->
        <h2>Earnings Graph</h2>
        <div class="chart-container">
            <canvas id="growthChart"></canvas>
            <div class="chart-legend">
                <div class="legend-item"><span style="background:var(--mc-green);"></span>CurseForge</div>
                <div class="legend-item"><span style="background:var(--mc-orange);"></span>External Sources</div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="cursor:pointer; color:#aaa; font-size:0.6rem;" onclick="toggleLogTable()">
                [Click to Toggle Data Table]
            </div>
            <div style="display:flex; gap:5px;">
                 <label class="action-btn" style="background:#42b74f; cursor:pointer;">
                    IMPORT <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData()">
                 </label>
                 <button class="action-btn" style="background:#5555ff;" onclick="exportData()">EXPORT</button>
            </div>
        </div>

        <div id="logTableContainer" style="display:none;">
            <table class="data-table">
                <thead>
                    <tr><th>Date</th><th>Points</th><th>Note</th><th>Total $</th><th>Action</th></tr>
                </thead>
                <tbody id="logTableBody"></tbody>
            </table>
        </div>

        <!-- Groups -->
        <div class="reference-box">
            <button class="edit-groups-btn" onclick="openEditGroups()">[MANAGE PROJECTS]</button>
            <strong>Strategy Groups:</strong><br><br>
            <div id="groupsDisplay"></div>
        </div>

        <!-- Weekly Grid -->
        <div class="week-grid" id="weekGrid"></div>
        <button class="btn" onclick="archiveAndReset()">>> FINISH WEEK & ARCHIVE <<</button>
    </div>

    <script>
        // --- 0. DATA MODEL ---
        // FIX #1: Initialize pointsLog as empty array to prevent undefined errors
        let appData = {
            points: 18, 
            goal: 120, 
            streak: 0, 
            rate: 0.05, 
            lastLoginDate: "", 
            lastCFLogin: "", 
            lastAuditDate: "",
            revenueSources: [ {name:"Adsterra", val:0}, {name:"YouTube", val:0} ], 
            currentWeekData: [
                { day: "MON", tasks: ["Update Group A", "Check Comments"] },
                { day: "TUE", tasks: ["Code: New Project (2hrs)", "Update Group B"] },
                { day: "WED", tasks: ["Polish New Project", "Update Group C"] },
                { day: "THU", tasks: ["Create Thumbnail", "Update Group D"] },
                { day: "FRI", tasks: ["RELEASE DAY"] },
                { day: "SAT", tasks: ["Update Group A", "Reply Comments"] },
                { day: "SUN", tasks: ["Rest / Analytics"] }
            ],
            groups: { A: [], B: [], C: [], D: [] }, 
            history: [], 
            pointsLog: [] // FIX: Ensure initialized
        };

        // --- 1. CORE HELPERS (Hoisting Safety) ---
        function getRate() { 
            const el = document.getElementById('pointRate');
            return el ? (parseFloat(el.value) || 0.05) : 0.05; 
        }

        function saveData() {
            const elPoints = document.getElementById('currentPoints');
            if(elPoints) appData.points = elPoints.value;
            const elGoal = document.getElementById('goalPoints');
            if(elGoal) appData.goal = elGoal.value;
            const elRate = document.getElementById('pointRate');
            if(elRate) appData.rate = elRate.value;
            localStorage.setItem('bedrockTracker_v36_core', JSON.stringify(appData));
        }

        // --- 2. RENDERERS ---
        function renderLogTable() {
            const tbody = document.getElementById('logTableBody');
            if(!tbody) return;
            const rate = getRate();
            tbody.innerHTML = "";
            // FIX #2: Add null check for pointsLog before reversing
            if (appData.pointsLog && appData.pointsLog.length > 0) {
                [...appData.pointsLog].reverse().forEach((l,i) => {
                    const earn = (l.value*rate) + (l.externalRevenue||0);
                    const idx = appData.pointsLog.length - 1 - i;
                    tbody.innerHTML += `<tr><td>${l.date}</td><td style="color:#42b74f">${l.value}</td><td>${l.note||'-'}</td><td>$${earn.toFixed(2)}</td><td><span class='delete-btn' onclick='deleteLogEntry(${idx})'>[DEL]</span></td></tr>`;
                });
            }
        }

        function renderGroups() {
            const container = document.getElementById('groupsDisplay');
            if(!container) return;
            container.innerHTML = "";
            ['A','B','C','D'].forEach(g => {
                const projects = appData.groups[g] || [];
                let totalDL = 0; let rows = "";
                projects.forEach(p => {
                    const dl = parseInt(p.downloads) || 0;
                    totalDL += dl;
                    // FIX #3: Add null check for lastDiff to prevent NaN display
                    let diffHtml = (p.lastDiff && p.lastDiff > 0) ? `<span class="growth-indicator">(+${p.lastDiff.toLocaleString()})</span>` : "";
                    rows += `<div class="project-row-display"><span>${p.name}</span><span>${dl.toLocaleString()} ${diffHtml}</span></div>`;
                });
                const color = g === 'A' ? "var(--mc-yellow)" : "#aaa";
                container.innerHTML += `<div class="group-block" style="border-color:${color}"><div style="color:${color}; margin-bottom:5px;">GROUP ${g} <span style="float:right; font-size:0.6rem;">${totalDL.toLocaleString()}</span></div>${rows}</div>`;
            });
        }

        function renderWeek() {
            const grid = document.getElementById('weekGrid');
            if(!grid) return;
            grid.innerHTML = '';
            appData.currentWeekData.forEach((day, di) => {
                let tasks = "";
                day.tasks.forEach((t, ti) => {
                    const done = typeof t === 'object' ? t.done : false;
                    const text = typeof t === 'object' ? t.text : t;
                    tasks += `<div class="task-item ${done?'completed':''}" onclick="toggleTask(${di},${ti})"><div class="mc-checkbox"></div><span>${text}</span></div>`;
                });
                grid.innerHTML += `<div class="day-card"><div class="day-title">${day.day}</div>${tasks}</div>`;
            });
        }

        function drawChart() {
            const canvas = document.getElementById('growthChart');
            if(!canvas || !canvas.parentElement) return; 
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.parentElement.offsetWidth;
            const h = canvas.height = 320;

            ctx.fillStyle = "#222"; 
            ctx.fillRect(0, 0, w, h);
            
            // FIX #4: Add safety check for pointsLog existence
            const logs = (appData.pointsLog && appData.pointsLog.length > 0) ? appData.pointsLog : [];
            if (logs.length === 0) {
                ctx.fillStyle = "#555"; 
                ctx.textAlign="center"; 
                ctx.font = "12px monospace";
                ctx.fillText("NO DATA TO DISPLAY", w/2, h/2);
                return;
            }

            const rate = getRate();
            const cfData = logs.map(l => (parseInt(l.value) * rate));
            const extData = logs.map(l => parseFloat(l.externalRevenue) || 0);

            const maxVal = Math.max(...cfData, ...extData, 1);
            const padY = 60;
            const padX = 50; 
            const drawH = h - (padY * 2);
            const drawW = w - (padX * 2);
            
            const stepX = logs.length > 1 ? drawW / (logs.length - 1) : 0;

            function getX(i) { return logs.length > 1 ? padX + (i * stepX) : w/2; }
            function getY(val) { return h - padY - ((val / maxVal) * drawH); }

            function drawCurve(data, color, fillStyle, labelDir) {
                if(data.length === 0) return;
                
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 4;

                if (data.length === 1) {
                    const x = getX(0); 
                    const y = getY(data[0]);
                    ctx.fillStyle = color; 
                    ctx.beginPath(); 
                    ctx.arc(x, y, 6, 0, Math.PI*2); 
                    ctx.fill();
                } else {
                    ctx.moveTo(getX(0), getY(data[0]));
                    for (let i = 0; i < data.length - 1; i++) {
                        const x1 = getX(i);
                        const y1 = getY(data[i]);
                        const x2 = getX(i+1);
                        const y2 = getY(data[i+1]);
                        const cp1x = x1 + (x2 - x1) / 2;
                        ctx.bezierCurveTo(cp1x, y1, cp1x, y2, x2, y2);
                    }
                    ctx.stroke();

                    // Area Fill
                    ctx.lineTo(getX(data.length - 1), h - padY);
                    ctx.lineTo(getX(0), h - padY);
                    ctx.closePath();
                    const grad = ctx.createLinearGradient(0, padY, 0, h - padY);
                    grad.addColorStop(0, fillStyle);
                    grad.addColorStop(1, "rgba(0,0,0,0)");
                    ctx.fillStyle = grad;
                    ctx.fill();
                }

                // Points & Labels
                data.forEach((val, i) => {
                    const x = getX(i);
                    const y = getY(val);
                    ctx.fillStyle = color;
                    ctx.beginPath(); 
                    ctx.arc(x, y, 5, 0, Math.PI*2); 
                    ctx.fill();
                    
                    ctx.fillStyle = "#fff";
                    ctx.textAlign = "center";
                    ctx.font = "8px 'Press Start 2P'";
                    const offset = labelDir === 1 ? -15 : 25;
                    ctx.fillText("$" + val.toFixed(2), x, y + offset);
                    
                    if (labelDir === 1) {
                        ctx.fillStyle = "#666";
                        ctx.fillText(logs[i].date, x, h - 15);
                    }
                });
            }

            // FIX #5: Draw grid lines with proper stroke reset
            ctx.strokeStyle = "#333";
            ctx.setLineDash([5, 5]);
            for(let i=0; i<logs.length; i++) {
                ctx.beginPath(); 
                ctx.moveTo(getX(i), padY); 
                ctx.lineTo(getX(i), h-padY); 
                ctx.stroke();
            }
            ctx.setLineDash([]);

            // FIX #6: Use actual color values instead of CSS variables which don't work in canvas
            drawCurve(cfData, "#42b74f", "rgba(66, 183, 79, 0.3)", 1);
            drawCurve(extData, "#e67e22", "rgba(230, 126, 34, 0.3)", -1);
        }

        // --- 3. CALCULATIONS ---
        function calculateHistoricalTotals() {
            const rate = getRate();
            const now = new Date(); 
            now.setHours(0,0,0,0);
            let sum7 = 0; 
            let prev7 = 0; 
            let sum30 = 0;
            
            // FIX #7: Add null check for pointsLog
            if (appData.pointsLog && appData.pointsLog.length > 0) {
                appData.pointsLog.forEach(log => {
                    const d = new Date(log.date); 
                    d.setHours(0,0,0,0);
                    const diff = Math.round((now - d) / (1000*60*60*24));
                    const val = (parseInt(log.value)*rate) + (log.externalRevenue||0);
                    if(diff >= 0 && diff < 7) sum7 += val;
                    if(diff >= 7 && diff < 14) prev7 += val;
                    if(diff >= 0 && diff < 30) sum30 += val;
                });
            }
            
            const el7 = document.getElementById('last7TotalDisplay');
            if (el7) el7.innerText = sum7.toFixed(2);
            
            const el30 = document.getElementById('last30TotalDisplay');
            if (el30) el30.innerText = sum30.toFixed(2);
            
            const momEl = document.getElementById('mom7');
            if (momEl) {
                momEl.innerText = sum7 >= prev7 ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è";
                momEl.style.color = sum7 >= prev7 ? "#55ff55" : "#ff5555";
            }

            // FIX #8: Safe lifetime calculation with proper default
            let lifetime = 0;
            if (appData.pointsLog && appData.pointsLog.length > 0) {
                lifetime = appData.pointsLog.reduce((a,b) => a + (parseInt(b.value)*rate) + (b.externalRevenue||0), 0);
            }
            const elLife = document.getElementById('lifetimeDisplay');
            if (elLife) elLife.innerText = lifetime.toFixed(2);

            // FIX #9: Safe average calculation
            if(appData.pointsLog && appData.pointsLog.length > 0) {
                 const recent = appData.pointsLog.slice(-7);
                 let recentSum = 0;
                 recent.forEach(l => recentSum += (parseInt(l.value)*rate)+(l.externalRevenue||0));
                 const elAvg = document.getElementById('avg7DayDisplay');
                 if (elAvg) elAvg.innerText = (recentSum/recent.length).toFixed(2);
            }
        }

        function updateRevenue() {
            const ptsInput = document.getElementById('currentPoints');
            const pts = ptsInput ? (parseInt(ptsInput.value) || 0) : 0;
            const rate = getRate();
            let extTotal = 0;
            // FIX #10: Add null check for revenueSources
            if (appData.revenueSources && appData.revenueSources.length > 0) {
                appData.revenueSources.forEach(s => extTotal += parseFloat(s.val)||0);
            }
            
            const gross = (pts * rate) + extTotal;
            const revDisp = document.getElementById('revenueDisplay');
            if (revDisp) revDisp.innerText = gross.toFixed(2);
            
            // FIX #11: Update revenue hub display when modal is open
            const revHubCF = document.getElementById('revHubCF');
            if (revHubCF) revHubCF.innerText = "$" + (pts * rate).toFixed(2);
            const revHubTotal = document.getElementById('revHubTotal');
            if (revHubTotal) revHubTotal.innerText = gross.toFixed(2);
            
            saveData();
            calculateHistoricalTotals();
            renderLogTable(); 
            drawChart();
        }

        function refreshAll() {
            updateRevenue(); 
            renderGroups(); 
            renderWeek();
            const streakVal = document.getElementById('streakValue');
            if (streakVal) streakVal.innerText = appData.streak || 0;
        }

        // --- 4. HANDLERS ---
        window.logPoints = function() {
            const elPts = document.getElementById('currentPoints');
            const elNote = document.getElementById('logNote');
            const current = elPts ? parseInt(elPts.value) : 0;
            const note = elNote ? elNote.value : "";
            const date = new Date().toLocaleDateString('en-US', {month:'numeric', day:'numeric'});
            let ext = 0; 
            // FIX #12: Safe loop through revenue sources
            if (appData.revenueSources && appData.revenueSources.length > 0) {
                appData.revenueSources.forEach(s => ext += parseFloat(s.val)||0);
            }
            
            // FIX #13: Initialize pointsLog if it doesn't exist
            if (!appData.pointsLog) {
                appData.pointsLog = [];
            }
            
            appData.pointsLog.push({date, value:current, note, externalRevenue:ext});
            if(appData.pointsLog.length > 30) appData.pointsLog.shift();
            
            // FIX #14: Clear the note input after logging
            if (elNote) elNote.value = "";
            
            updateRevenue(); 
            alert("Logged!");
        }

        window.confirmDailyPoints = function() {
            const v = document.getElementById('dailyPointsInput').value;
            const noteVal = document.getElementById('dailyNoteInput').value;
            if(v) { 
                const el = document.getElementById('currentPoints');
                if (el) el.value = v;
                const elNote = document.getElementById('logNote');
                if (elNote) elNote.value = noteVal || "";
                window.logPoints(); 
            }
            document.getElementById('newDayModal').style.display='none';
            appData.lastLoginDate = new Date().toLocaleDateString();
            saveData();
        }

        window.deleteLogEntry = function(index) { 
            if(confirm("Delete?")) { 
                // FIX #15: Safe array splice with bounds checking
                if (appData.pointsLog && index >= 0 && index < appData.pointsLog.length) {
                    appData.pointsLog.splice(index, 1); 
                    saveData();
                    refreshAll(); 
                }
            } 
        }
        
        window.saveGoal = function() { saveData(); drawChart(); }
        
        window.toggleLogTable = () => { 
            const el=document.getElementById('logTableContainer'); 
            if(el) el.style.display = el.style.display==='none'?'block':'none'; 
        }
        
        window.toggleUtility = () => { 
            const el=document.getElementById('utilityTool'); 
            if(el) el.style.display=el.style.display==='none'?'grid':'none'; 
        }
        
        window.openRevenueHub = () => {
             const c = document.getElementById('revSourcesContainer'); 
             if(!c) return;
             c.innerHTML="";
             // FIX #16: Initialize revenueSources if missing
             if (!appData.revenueSources) {
                 appData.revenueSources = [{name:"Adsterra", val:0}, {name:"YouTube", val:0}];
             }
             appData.revenueSources.forEach((s,i) => {
                 c.innerHTML += `<div class='rev-row'><span>${s.name}</span><input type='number' class='rev-input' value='${s.val}' onchange='appData.revenueSources[${i}].val=parseFloat(this.value)||0; updateRevenue();'></div>`;
             });
             document.getElementById('revenueHubModal').style.display='flex';
             // Update display when opening
             updateRevenue();
        };

        window.saveRevenueHub = () => { 
            document.getElementById('revenueHubModal').style.display='none'; 
            saveData();
            updateRevenue(); 
        };
        
        window.addRevenueSource = () => { 
            const n = prompt("Name:"); 
            if(n) { 
                if (!appData.revenueSources) appData.revenueSources = [];
                appData.revenueSources.push({name:n, val:0}); 
                window.openRevenueHub(); 
            } 
        };
        
        window.resetInactivityTimer = () => { 
            appData.lastCFLogin = new Date().toLocaleDateString(); 
            saveData(); 
            alert("Reset!"); 
        };
        
        window.openEditGroups = () => { 
            document.getElementById('editGroupsModal').style.display='flex'; 
            renderEditModalContent(); 
        };
        
        let tempGroups = {};
        
        function renderEditModalContent() {
            // FIX #17: Deep clone with proper initialization
            tempGroups = {
                A: appData.groups.A ? JSON.parse(JSON.stringify(appData.groups.A)) : [],
                B: appData.groups.B ? JSON.parse(JSON.stringify(appData.groups.B)) : [],
                C: appData.groups.C ? JSON.parse(JSON.stringify(appData.groups.C)) : [],
                D: appData.groups.D ? JSON.parse(JSON.stringify(appData.groups.D)) : []
            };
            
            const c = document.getElementById('groupEditContainer'); 
            if(!c) return;
            c.innerHTML="";
            ['A','B','C','D'].forEach(g => {
                 const d = document.createElement('div');
                 d.innerHTML = `<div style="margin-bottom:5px; color:#aaa;">GROUP ${g}</div>`;
                 if (tempGroups[g] && tempGroups[g].length > 0) {
                     tempGroups[g].forEach((p,i) => {
                         // FIX #18: Escape quotes in project names to prevent HTML breaking
                         const safeName = (p.name || '').replace(/"/g, '&quot;');
                         d.innerHTML += `<div class='project-edit-row'><input class='proj-name-input' value="${safeName}" onchange="tempGroups['${g}'][${i}].name=this.value"><input type='number' class='proj-dl-input' value="${p.downloads || 0}" onchange="tempGroups['${g}'][${i}].downloads=this.value"><div class='proj-del-btn' onclick="tempGroups['${g}'].splice(${i},1);renderEditModalContent();">X</div></div>`;
                     });
                 }
                 d.innerHTML += `<div class='add-proj-btn' onclick="tempGroups['${g}'].push({name:'New',downloads:0,lastDiff:0});renderEditModalContent();">+ ADD</div>`;
                 c.appendChild(d);
            });
        }
        
        window.saveGroups = () => {
             // FIX #19: Calculate diff for all groups with proper initialization
             ['A','B','C','D'].forEach(g => {
                 if (!appData.groups[g]) appData.groups[g] = [];
                 if (!tempGroups[g]) tempGroups[g] = [];
                 
                 tempGroups[g].forEach(np => {
                     const op = appData.groups[g].find(x => x.name === np.name);
                     if(op) {
                         np.lastDiff = parseInt(np.downloads || 0) - parseInt(op.downloads || 0);
                     } else {
                         np.lastDiff = 0;
                     }
                 });
             });
             appData.groups = tempGroups; 
             saveData(); 
             renderGroups(); 
             document.getElementById('editGroupsModal').style.display='none';
        };

        window.openCFPasteModal = () => document.getElementById('cfPasteModal').style.display='flex';
        
        window.copyScraperScript = () => {
             // FIX #20: Updated scraper with better error handling
             const s = `(function() {
    let projects = [];
    // 1. Target dashboard table rows
    let rows = document.querySelectorAll('table tbody tr');
    
    // Fallback for list view if table is empty
    if (rows.length === 0) rows = document.querySelectorAll('.project-listing-row, .project-card');

    rows.forEach(row => {
        // --- FIND NAME ---
        // Priority 1: Look for class names often used for titles
        let nameEl = row.querySelector('.project-name, .name h3, h3, .project-title');
        
        // Priority 2: If no class, find the first link that is NOT "Edit/Manage"
        if (!nameEl) {
            let links = row.querySelectorAll('a');
            for(let link of links) {
                let txt = link.innerText.trim();
                // Filter out bad words
                if (txt.length > 1 && txt !== "Edit" && txt !== "Manage" && txt !== "Delete" && txt !== "View") {
                    nameEl = link;
                    break; // Found the first real text link
                }
            }
        }

        // --- FIND DOWNLOADS ---
        let dlText = "0";
        // Look for specific download classes
        let dlEl = row.querySelector('.downloads, .download-count');
        
        if (dlEl) {
            dlText = dlEl.innerText;
        } else {
            // Fallback: Check all cells for a number pattern (e.g. "25.9k" or "4,200")
            let cells = row.querySelectorAll('td, span');
            for (let cell of cells) {
                let txt = cell.innerText.trim();
                // Matches numbers, excludes dates (/) and times (:)
                if (txt.match(/^[\d,.]+[kKmM]?$/) && !txt.includes('/') && !txt.includes(':')) {
                    dlText = txt;
                }
            }
        }

        // --- SAVE DATA ---
        if (nameEl) {
            let name = nameEl.innerText.trim();
            // Final safety check
            if (name === "Edit") return;

            // Process number
            let raw = dlText.toLowerCase().replace(/,/g, '').replace('downloads','').trim();
            let multiplier = 1;
            if (raw.includes('k')) { multiplier = 1000; raw = raw.replace('k', ''); }
            if (raw.includes('m')) { multiplier = 1000000; raw = raw.replace('m', ''); }
            
            let count = parseFloat(raw) * multiplier;
            
            if (!isNaN(count) && count > 0) {
                projects.push({ name: name, downloads: count });
            }
        }
    });

    if(projects.length > 0) {
        const jsonOutput = JSON.stringify(projects);
        console.log("‚úÖ FIXED LIST:");
        console.log(jsonOutput);
        
        // Auto-copy
        const el = document.createElement('textarea');
        el.value = jsonOutput;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        alert("SUCCESS! Copied " + projects.length + " projects with correct names.\nGo paste it in your Tracker now.");
    } else {
        alert("‚ùå No projects found. Ensure you are on the 'My Projects' list page.");
    }
})();`;
             const textArea = document.createElement("textarea");
             textArea.value = s;
             document.body.appendChild(textArea);
             textArea.select();
             document.execCommand('copy');
             document.body.removeChild(textArea);
             alert("SCRAPER SCRIPT COPIED!");
        };

        window.processCFPaste = () => {
             try {
                 const arr = JSON.parse(document.getElementById('cfPasteArea').value);
                 if (!Array.isArray(arr)) throw new Error("Invalid data format");
                 
                 arr.sort((a,b)=>(b.downloads||0)-(a.downloads||0));
                 // FIX #21: Initialize groups properly before slicing
                 appData.groups.A = arr.slice(0,4).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 appData.groups.B = arr.slice(4,8).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 appData.groups.C = arr.slice(8,12).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 appData.groups.D = arr.slice(12).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 
                 saveData(); 
                 refreshAll(); 
                 document.getElementById('cfPasteModal').style.display='none';
                 alert("Projects imported successfully!");
             } catch(e) { 
                 alert("Invalid JSON format. Please paste valid data."); 
                 console.error(e);
             }
        };

        window.toggleTask = (di, ti) => {
            // FIX #22: Bounds checking for task toggle
            if (!appData.currentWeekData[di] || !appData.currentWeekData[di].tasks[ti]) return;
            
            let t = appData.currentWeekData[di].tasks[ti];
            if(typeof t === 'string') {
                appData.currentWeekData[di].tasks[ti] = {text: t, done: true};
            } else {
                t.done = !t.done;
            }
            saveData(); 
            renderWeek();
        };

        window.archiveAndReset = () => {
            if(!confirm("Archive this week and start fresh?")) return;
            // FIX #23: Keep historical data, only reset weekly tasks
            appData.currentWeekData.forEach(day => {
                day.tasks = day.tasks.map(t => {
                    if (typeof t === 'object') return t.text;
                    return t;
                });
            });
            saveData(); 
            location.reload();
        }

        window.exportData = () => { 
            const b=new Blob([JSON.stringify(appData, null, 2)],{type:'application/json'}); 
            const u=URL.createObjectURL(b); 
            const a=document.createElement('a'); 
            a.href=u; 
            a.download='tracker_backup_' + new Date().toISOString().split('T')[0] + '.json'; 
            a.click(); 
            URL.revokeObjectURL(u);
        }
        
        window.importData = function() {
            const f = document.getElementById('importFile').files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (e) => { 
                try {
                    const imported = JSON.parse(e.target.result);
                    // FIX #24: Validate imported data structure
                    if (imported && typeof imported === 'object') {
                        appData = { ...appData, ...imported };
                        // Ensure critical arrays exist
                        if (!appData.pointsLog) appData.pointsLog = [];
                        if (!appData.revenueSources) appData.revenueSources = [];
                        if (!appData.groups) appData.groups = { A: [], B: [], C: [], D: [] };
                        
                        saveData(); 
                        location.reload();
                    } else {
                        throw new Error("Invalid file format");
                    }
                } catch(err) {
                    alert("Error importing file: " + err.message);
                }
            };
            r.readAsText(f);
        }

        function confirmAudit() {
             // FIX #25: Safe audit confirmation with validation
             ['A','B','C','D'].forEach(g => {
                 if (!appData.groups[g]) appData.groups[g] = [];
                 
                 appData.groups[g].forEach((p,i) => {
                     const el = document.getElementById(`audit-${g}-${i}`);
                     if (el && el.value) {
                         const newVal = parseInt(el.value) || 0;
                         p.lastDiff = newVal - (parseInt(p.downloads) || 0);
                         p.downloads = newVal;
                     }
                 });
             });
             appData.lastAuditDate = new Date().toLocaleDateString();
             saveData(); 
             refreshAll(); 
             document.getElementById('weeklyAuditModal').style.display='none';
        }

        // --- 5. INITIALIZATION ---
        function loadData() {
            const saved = localStorage.getItem('bedrockTracker_v36_core');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    appData = { ...appData, ...parsed };
                    
                    // FIX #26: Ensure all required properties exist after loading
                    if (!appData.pointsLog) appData.pointsLog = [];
                    if (!appData.revenueSources) appData.revenueSources = [{name:"Adsterra", val:0}, {name:"YouTube", val:0}];
                    if (!appData.groups) appData.groups = { A: [], B: [], C: [], D: [] };
                    if (!appData.currentWeekData) {
                        appData.currentWeekData = [
                            { day: "MON", tasks: ["Update Group A", "Check Comments"] },
                            { day: "TUE", tasks: ["Code: New Project (2hrs)", "Update Group B"] },
                            { day: "WED", tasks: ["Polish New Project", "Update Group C"] },
                            { day: "THU", tasks: ["Create Thumbnail", "Update Group D"] },
                            { day: "FRI", tasks: ["RELEASE DAY"] },
                            { day: "SAT", tasks: ["Update Group A", "Reply Comments"] },
                            { day: "SUN", tasks: ["Rest / Analytics"] }
                        ];
                    }
                } catch(e) { 
                    console.error("Error loading data:", e); 
                    // Keep default appData
                }
            }
            
            // FIX #27: Safe value restoration
            const elP = document.getElementById('currentPoints');
            if (elP) elP.value = appData.points || 18;
            
            const elG = document.getElementById('goalPoints');
            if (elG) elG.value = appData.goal || 120;
            
            const elR = document.getElementById('pointRate');
            if (elR) elR.value = appData.rate || 0.05;
            
            refreshAll();
        }

        window.onload = function() {
            loadData();
            
            // FIX #28: Clock update with proper date formatting
            setInterval(() => { 
                const clock = document.getElementById('clockDisplay');
                if (clock) {
                    const now = new Date();
                    clock.innerText = now.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }); 
                }
            }, 1000);

            // FIX #29: New day modal with proper date comparison
            const today = new Date().toLocaleDateString();
            if(appData.lastLoginDate !== today) {
                const modal = document.getElementById('newDayModal');
                if (modal) {
                    // Small delay to ensure DOM is ready
                    setTimeout(() => {
                        modal.style.display='flex';
                    }, 500);
                }
            }
            
            // FIX #30: Weekly audit check with safe date parsing
            const lastAudit = appData.lastAuditDate ? new Date(appData.lastAuditDate) : new Date(0);
            const diff = (new Date() - lastAudit)/(1000*60*60*24);
            
            if(diff > 7) {
                const c = document.getElementById('auditContainer'); 
                if (c) {
                    c.innerHTML="";
                    let hasProjects = false;
                    
                    ['A','B','C','D'].forEach(g => {
                        if(appData.groups[g] && appData.groups[g].length > 0) {
                            hasProjects = true;
                            c.innerHTML += `<div style="color:var(--mc-yellow); margin-top:10px;">GROUP ${g}</div>`;
                            appData.groups[g].forEach((p,i) => {
                                c.innerHTML += `<div class='stat-input-row'><span>${p.name}</span><input type='number' id='audit-${g}-${i}' value='${p.downloads || 0}'></div>`;
                            });
                        }
                    });
                    
                    // Only show modal if there are projects to audit
                    if (hasProjects) {
                        const auditModal = document.getElementById('weeklyAuditModal');
                        if (auditModal) {
                            setTimeout(() => {
                                auditModal.style.display='flex';
                            }, 1000);
                        }
                    }
                }
            }
        };

    </script>
</body>
</html>
