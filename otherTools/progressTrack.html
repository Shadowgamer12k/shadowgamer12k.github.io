<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bedrock Addon Tracker (Pro)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --mc-bg: #48494a;
            --mc-panel: #313233;
            --mc-border-light: #5b5b5b;
            --mc-border-dark: #1e1e1f;
            --mc-green: #42b74f;
            --mc-blue: #5555ff;
            --mc-red: #ff5555;
            --mc-yellow: #fcfc00;
            --mc-purple: #b266ff;
            --mc-text: #ffffff;
            --mc-orange: #e67e22;
        }

        /* FEATURE 1: Nether Theme */
        body.nether-theme {
            --mc-bg: #2a0505;
            --mc-panel: #4a1010;
            --mc-border-light: #852d2d;
            --mc-border-dark: #1a0000;
            --mc-green: #ffaa00; /* Gold replaces Green */
            --mc-text: #ffdddd;
            background-image: linear-gradient(rgba(40,0,0,0.8), rgba(40,0,0,0.8)), url('https://assets.codepen.io/13471/netherrack-bg.jpg');
        }

        body {
            background-color: #1a1a1a;
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://assets.codepen.io/13471/dirt-bg.jpg');
            color: var(--mc-text);
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            line-height: 1.5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            background-color: var(--mc-bg);
            border: 4px solid #000;
            outline: 4px solid var(--mc-border-light);
            padding: 20px;
            box-shadow: 10px 10px 0 #000;
            position: relative;
        }

        /* Header */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--mc-border-dark);
            padding-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1 { 
            color: var(--mc-yellow); 
            font-size: 1.5rem; 
            text-shadow: 3px 3px #000;
            margin: 0;
            text-transform: uppercase;
        }

        /* FEATURE 1 (New): Splash Text */
        .splash-text {
            color: var(--mc-yellow);
            font-size: 0.6rem;
            text-align: right;
            transform: rotate(-5deg);
            animation: bounce 1s infinite alternate;
            margin-top: 5px;
            text-shadow: 2px 2px #000;
            max-width: 200px;
        }
        @keyframes bounce { from { transform: scale(1) rotate(-5deg); } to { transform: scale(1.1) rotate(-5deg); } }

        .header-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .date-display { font-size: 0.7rem; color: #aaa; }
        .streak-display { color: var(--mc-orange); font-size: 0.7rem; text-shadow: 2px 2px #000; }
        /* FEATURE 2: Global Download Counter */
        .total-dl-display { color: var(--mc-blue); font-size: 0.65rem; text-shadow: 1px 1px #000; margin-top: 3px; }

        /* FEATURE 2 (New): Boss Bar Milestone */
        .boss-bar-container {
            position: relative;
            width: 100%;
            height: 15px;
            background: #220022;
            border: 2px solid #000;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .boss-bar-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: #b266ff;
            width: 0%;
            transition: width 0.5s;
            opacity: 0.8;
        }
        .boss-bar-text {
            position: relative;
            z-index: 2;
            font-size: 0.55rem;
            color: #fff;
            text-shadow: 1px 1px #000;
            letter-spacing: 1px;
        }

        /* Daily Goal Meter */
        .goal-meter-container {
            background: #222;
            border: 2px solid var(--mc-border-dark);
            height: 10px;
            width: 100%;
            margin-bottom: 30px;
            position: relative;
        }
        .goal-meter-fill {
            background: linear-gradient(90deg, var(--mc-green), var(--mc-yellow));
            height: 100%;
            width: 0%;
            transition: width 0.5s ease-in-out;
        }
        body.nether-theme .goal-meter-fill {
            background: linear-gradient(90deg, #ff5555, #fcfc00);
        }
        .goal-meter-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.5rem;
            color: #fff;
            text-shadow: 1px 1px #000;
            z-index: 2;
        }

        h2 {
            font-size: 1rem;
            text-shadow: 2px 2px #000;
            margin: 30px 0 15px 0;
            border-bottom: 2px solid #555;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Stats Grid */
        .stats-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px;
            background: rgba(0,0,0,0.2); padding: 20px;
            border: 3px solid var(--mc-border-dark); border-bottom: 3px solid var(--mc-border-light);
            margin-bottom: 25px; align-items: start;
        }

        .stat-box {
            text-align: center;
            background: rgba(0,0,0,0.2);
            padding: 10px 5px;
            border: 1px solid #444;
        }
        
        .stat-box div:first-child {
            color: #aaa; margin-bottom: 8px; font-size: 0.5rem; text-transform: uppercase; letter-spacing: 1px;
        }
        
        .stat-box input {
            background: transparent; border: none; color: var(--mc-green);
            font-family: 'Press Start 2P'; font-size: 0.8rem;
            width: 100%; text-align: center;
        }

        .val-green { color: var(--mc-green); font-size: 0.8rem; }
        .val-yellow { color: var(--mc-yellow); font-size: 0.8rem; }
        .val-blue { color: var(--mc-blue); font-size: 0.8rem; }
        .val-purple { color: var(--mc-purple); font-size: 0.8rem; }
        .val-red { color: var(--mc-red); font-size: 0.8rem; }
        .val-gold { color: #ffd700; font-size: 0.8rem; text-shadow: 1px 1px #000; }

        .action-btn {
            background: #555; border: 2px solid #000; color: white;
            font-family: 'Press Start 2P'; font-size: 0.6rem;
            padding: 5px 10px; cursor: pointer; margin-left: 5px;
        }
        .action-btn:hover { background: #777; }
        
        /* FEATURE 3 (New): Quick Add Buttons */
        .quick-add-row {
            display: flex; gap: 3px; margin-bottom: 5px; justify-content: center;
        }
        .quick-btn {
            background: #333; color: var(--mc-green); border: 1px solid #555; 
            font-size: 0.5rem; padding: 2px 4px; cursor: pointer; font-family: 'Press Start 2P';
        }
        .quick-btn:hover { background: #444; color: #fff; }

        .log-input-group {
            display: flex;
            flex-direction: column; gap: 5px; align-items: center;
        }
        .note-input {
            background: #222; border: 2px solid #555; color: #fff;
            font-family: 'Press Start 2P', cursive; font-size: 0.5rem;
            padding: 3px; width: 90%; text-align: center;
        }

        /* Graph */
        .chart-container {
            background: #222; border: 3px solid var(--mc-border-dark);
            border-bottom: 3px solid var(--mc-border-light);
            padding: 10px; margin-bottom: 10px; position: relative;
        }
        canvas { width: 100%; height: 350px; display: block; }
        .chart-legend { display: flex; justify-content: center; gap: 20px; font-size: 0.6rem; margin-top: 5px; color: #aaa; }
        .legend-item span { display: inline-block; width: 10px; height: 10px; margin-right: 5px; border: 1px solid #000; }

        /* Tables */
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 0.7rem;
            margin-bottom: 30px; background: #222; border: 2px solid var(--mc-border-dark);
        }
        .data-table th { background: #333; padding: 10px; text-align: left; color: #aaa; }
        .data-table td { padding: 10px; border-bottom: 1px solid #444; }
        .data-table tr:hover { background: #2a2a2a; }
        .delete-btn { color: #ff5555; cursor: pointer; text-decoration: underline; }

        /* Groups */
        .reference-box {
            background: rgba(0,0,0,0.3); padding: 15px; font-size: 0.7rem;
            margin-bottom: 25px; border: 3px solid var(--mc-border-dark);
            line-height: 1.8; position: relative;
        }
        .edit-groups-btn {
            position: absolute; top: 10px; right: 10px;
            background: #555; color: #fff; border: 1px solid #000;
            font-family: 'Press Start 2P'; font-size: 0.5rem; padding: 5px; cursor: pointer;
        }
        .group-block { margin-bottom: 15px; border-left: 2px solid #555; padding-left: 10px; }
        .project-row-display {
            display: flex; justify-content: space-between; font-size: 0.6rem;
            color: #ddd; border-bottom: 1px solid #333; padding: 2px 0;
        }
        .growth-indicator { color: var(--mc-green); font-size: 0.5rem; margin-left: 5px; }
        .top-performer { color: #ffd700 !important; font-weight: bold; text-shadow: 1px 1px 0 rgba(0,0,0,0.5); }

        /* Weekly Grid */
        .week-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .day-card { background-color: var(--mc-panel); border: 3px solid var(--mc-border-dark); padding: 15px; position: relative; padding-bottom: 25px; }
        .day-title { color: #d1d1d1; border-bottom: 3px solid #555; padding-bottom: 8px; margin-bottom: 15px; font-size: 0.8rem; text-align: center; }
        .task-item { display: flex; align-items: flex-start; margin-bottom: 12px; cursor: pointer; font-size: 0.65rem; }
        .task-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mc-checkbox { min-width: 16px; min-height: 16px; background: #000; border: 2px solid #666; margin-right: 10px; display: flex; align-items: center; justify-content: center; }
        .task-item.completed .mc-checkbox::after { content: ''; width: 8px; height: 8px; background-color: var(--mc-green); display: block; }
        .btn { background-color: #7d7d7d; border: 3px solid #000; color: #fff; font-family: 'Press Start 2P'; font-size: 0.9rem; padding: 15px 20px; cursor: pointer; width: 100%; margin-top: 30px; }
        
        .task-progress-track {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; background: #222;
        }
        .task-progress-fill {
            height: 100%; background: var(--mc-green); width: 0%; transition: width 0.3s;
        }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-box { background: var(--mc-bg); border: 4px solid white; outline: 4px solid black; padding: 30px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { color: var(--mc-yellow); margin-bottom: 20px; font-size: 1.2rem; }
        .modal-input { background: #222; border: 2px solid #555; color: white; font-family: 'Press Start 2P'; font-size: 1rem; padding: 10px; width: 100px; text-align: center; display: block; margin: 10px auto; }
        .modal-btn { background: var(--mc-green); border: 2px solid #000; color: white; font-family: 'Press Start 2P'; padding: 15px 30px; cursor: pointer; }
        #cfPasteModal { z-index: 2000 !important; }

        .project-edit-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .proj-name-input { background: #111; border: 1px solid #555; color: white; font-family: 'Press Start 2P'; font-size: 0.6rem; padding: 5px; flex-grow: 1; }
        .proj-dl-input { background: #111; border: 1px solid #555; color: var(--mc-green); font-family: 'Press Start 2P'; font-size: 0.6rem; padding: 5px; width: 60px; text-align: right; }
        .proj-del-btn { background: var(--mc-red); color: white; border: 1px solid #000; cursor: pointer; padding: 5px; font-size: 0.6rem; }
        .stat-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.8rem; color: #ddd; }
        .stat-input-row input { width: 100px; padding: 5px; background: #111; border: 1px solid #555; color: white; font-family: 'Press Start 2P'; text-align: right; }
        
        .rev-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .rev-input { background: #111; border: 1px solid #555; color: var(--mc-green); font-family: 'Press Start 2P'; font-size: 0.7rem; width: 80px; text-align: right; }
        .paste-textarea { width: 100%; height: 200px; background: #000; color: #0f0; border: 2px solid #555; font-family: monospace; font-size: 0.6rem; padding: 10px; box-sizing: border-box; resize: vertical; }
        .add-proj-btn { background: #333; color: #aaa; border: 1px dashed #666; width: 100%; font-size: 0.6rem; padding: 5px; cursor: pointer; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="weeklyAuditModal" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--mc-red);">
            <div class="modal-title" style="color:var(--mc-red);">‚ö†Ô∏è WEEKLY PROJECT CHECK</div>
            <p style="font-size:0.6rem; color:#aaa; margin-bottom:20px;">You must update the TOTAL DOWNLOADS for every project.<br>Check your CurseForge Dashboard!</p>
            <div id="auditContainer" style="text-align: left;"></div>
            <button class="modal-btn" style="background:var(--mc-red); margin-top:20px;" onclick="confirmAudit()">UPDATE ALL STATS</button>
        </div>
    </div>

    <div id="revenueHubModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="color:var(--mc-green);">REVENUE HUB</div>
            <p style="font-size:0.6rem; color:#aaa; margin-bottom:20px;">External Earnings for Today</p>
            <div id="revSourcesContainer"></div>
            <div class="rev-row" style="margin-top:10px;">
                <span style="color:var(--mc-yellow)">CurseForge Est:</span>
                <span id="revHubCF">$0.00</span>
            </div>
            <div style="font-size:1rem; margin-top:20px; color:var(--mc-green)">
                TOTAL: $<span id="revHubTotal">0.00</span>
            </div>
            <button class="modal-btn" style="margin-top:20px;" onclick="saveRevenueHub()">SAVE & CLOSE</button>
            <button class="action-btn" style="background:#444; margin-top:10px;" onclick="addRevenueSource()">+ ADD SOURCE</button>
        </div>
    </div>

    <div id="cfPasteModal" class="modal-overlay">
        <div class="modal-box" style="max-width:700px;">
            <div class="modal-title" style="color:var(--mc-blue);">IMPORT CF DATA</div>
            <button class="action-btn" style="background:var(--mc-orange); margin-bottom:10px;" onclick="copyScraperScript()">[COPY CONSOLE SCRIPT]</button>
            <p style="font-size:0.6rem; color:#aaa; margin-bottom:10px;">Paste the array [...] from the console script below:</p>
            <textarea id="cfPasteArea" class="paste-textarea" placeholder='[{"name":"Project A","downloads":100} ...]'></textarea>
            <div style="margin-top:15px;">
                <button class="modal-btn" onclick="processCFPaste()">LOAD DATA</button>
                <button class="action-btn" style="background:#444;" onclick="document.getElementById('cfPasteModal').style.display='none'">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="editGroupsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">MANAGE PROJECTS</div>
            <div id="groupEditContainer"></div>
            <button class="modal-btn" onclick="saveGroups()">SAVE CHANGES</button>
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <button class="action-btn" style="background:#5555ff;" onclick="openCFPasteModal()">[PASTE CF DATA]</button>
                <button class="action-btn" style="background:#444;" onclick="document.getElementById('editGroupsModal').style.display='none'">CANCEL</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-section">
            <div style="display:flex; flex-direction:column;">
                <h1>Road To $200</h1>
                <div class="total-dl-display">Total DLs: <span id="totalDownloadsDisplay">0</span></div>
                <!-- FEATURE 1: Splash Text -->
                <div id="splashText" class="splash-text">Loading...</div>
            </div>
            <div class="header-right">
                <div style="display:flex; gap:5px; align-items:center;">
                    <button class="action-btn" style="background:var(--mc-red); color:#fff;" onclick="toggleTheme()">THEME</button>
                    <div class="date-display" id="clockDisplay">Loading...</div>
                </div>
                <div class="streak-display">üî• STREAK: <span id="streakValue">0</span> DAYS</div>
            </div>
        </div>
        
        <!-- FEATURE 2: Boss Bar Milestone -->
        <div class="boss-bar-container">
            <div id="bossBarFill" class="boss-bar-fill"></div>
            <div id="bossBarText" class="boss-bar-text">NEXT MILESTONE: $100</div>
        </div>

        <!-- Daily Goal Meter -->
        <div class="goal-meter-container">
            <div id="goalMeterFill" class="goal-meter-fill"></div>
            <div id="goalMeterText" class="goal-meter-text">Loading Goal...</div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-box">
                <div>$/Pt Rate</div>
                <input type="number" id="pointRate" value="0.05" class="rate-input" step="any" onchange="updateRevenue()">
            </div>
            <div class="stat-box">
                <div>Daily Goal</div>
                <input type="number" id="goalPoints" value="120" class="goal-input" onchange="saveGoal()">
            </div>
            <div class="stat-box" style="flex-grow:2;">
                <div>Log Pts</div>
                <div class="log-input-group">
                    <input type="number" id="currentPoints" value="18" step="any" onchange="updateRevenue()">
                    <!-- FEATURE 3: Quick Add Buttons -->
                    <div class="quick-add-row">
                        <button class="quick-btn" onclick="addPoints(1)">+1</button>
                        <button class="quick-btn" onclick="addPoints(5)">+5</button>
                        <button class="quick-btn" onclick="addPoints(10)">+10</button>
                    </div>
                    <input type="text" id="logNote" class="note-input" placeholder="Note">
                    <button class="action-btn" onclick="logPoints()">LOG</button>
                </div>
            </div>
            <div class="stat-box" style="cursor:pointer; border:1px solid var(--mc-green);" onclick="openRevenueHub()">
                <div>Daily $</div>
                <div class="val-green">$<span id="revenueDisplay">0.00</span></div>
            </div>
            <div class="stat-box">
                <div>Best Day</div>
                <div class="val-gold">$<span id="bestDayDisplay">0.00</span></div>
            </div>
            <div class="stat-box">
                <div>Lifetime $</div>
                <div class="val-purple">$<span id="lifetimeDisplay">0.00</span></div>
            </div>
            <div class="stat-box">
                <div>Days to $200</div>
                <div class="val-red" id="daysToGoalDisplay">--</div>
            </div>
        </div>

        <!-- Graph -->
        <h2 style="display:flex; justify-content:space-between; align-items:center;">
            Earnings Graph
            <!-- FEATURE 4: Focus Mode Toggle -->
            <button class="action-btn" style="font-size:0.5rem;" onclick="toggleFocus()">[TOGGLE GRAPH]</button>
        </h2>
        <div id="chartSection" class="chart-container">
            <canvas id="growthChart"></canvas>
            <div class="chart-legend">
                <div class="legend-item"><span style="background:var(--mc-green);"></span>CurseForge</div>
                <div class="legend-item"><span style="background:var(--mc-orange);"></span>External Sources</div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="cursor:pointer; color:#aaa; font-size:0.6rem;" onclick="toggleLogTable()">
                [Click to Toggle Data Table]
            </div>
            <div style="display:flex; gap:5px;">
                 <button class="action-btn" style="background:#b266ff;" onclick="copyDailyReport()">COPY REPORT</button>
                 <button class="action-btn" style="background:#e67e22;" onclick="exportCSV()">EXPORT CSV</button>
                 <label class="action-btn" style="background:#42b74f; cursor:pointer;">
                    IMPORT <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData()">
                 </label>
                 <button class="action-btn" style="background:#5555ff;" onclick="exportData()">EXPORT JSON</button>
            </div>
        </div>

        <div id="logTableContainer" style="display:none;">
            <table class="data-table">
                <thead>
                    <tr><th>Date</th><th>Points</th><th>Note</th><th>Total $</th><th>Action</th></tr>
                </thead>
                <tbody id="logTableBody"></tbody>
            </table>
        </div>

        <!-- Groups -->
        <div class="reference-box">
            <button class="edit-groups-btn" onclick="openEditGroups()">[MANAGE PROJECTS]</button>
            <strong>Strategy Groups:</strong><br><br>
            <div id="groupsDisplay"></div>
        </div>

        <!-- Weekly Grid -->
        <div class="week-grid" id="weekGrid"></div>
        <button class="btn" onclick="archiveAndReset()">>> FINISH WEEK & ARCHIVE <<</button>
    </div>

    <!-- UPGRADED SCRIPT TO USE FIREBASE FIRESTORE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. DATA MODEL (FIX: Attached to window for inline HTML access) ---
        window.appData = {
            points: 18, 
            goal: 120, 
            streak: 0, 
            rate: 0.05, 
            theme: "normal", 
            lastLoginDate: "", 
            lastCFLogin: "", 
            lastAuditDate: "",
            revenueSources: [ {name:"Adsterra", val:0}, {name:"YouTube", val:0} ], 
            currentWeekData: [
                { day: "MON", tasks: ["Update Group A", "Check Comments"] },
                { day: "TUE", tasks: ["Code: New Project (2hrs)", "Update Group B"] },
                { day: "WED", tasks: ["Polish New Project", "Update Group C"] },
                { day: "THU", tasks: ["Create Thumbnail", "Update Group D"] },
                { day: "FRI", tasks: ["RELEASE DAY", "Update Session"] },
                { day: "SAT", tasks: ["Update Group E", "Reply Comments"] },
                { day: "SUN", tasks: ["Rest / Analytics", "Update Group F"] }
            ],
            groups: { A: [], B: [], C: [], D: [], E: [], F: [] }, 
            history: [], 
            pointsLog: [] 
        };

        // Temporary data for edits (FIX: Attached to window)
        window.tempGroups = {};
        const GROUP_KEYS = ['A','B','C','D','E','F'];

        let db, auth, user;
        let firestoreDocRef = null;
        let useFirestore = false;

        // --- 1. CORE HELPERS ---
        function escapeHtml(text) {
            if (!text) return "";
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function getTodayString() {
            return new Date().toLocaleDateString('en-US');
        }

        function getRate() { 
            const el = document.getElementById('pointRate');
            return el ? (parseFloat(el.value) || 0.05) : 0.05; 
        }

        // UPGRADED SAVE FUNCTION
        function saveData() {
            const elPoints = document.getElementById('currentPoints');
            if(elPoints) window.appData.points = elPoints.value;
            const elGoal = document.getElementById('goalPoints');
            if(elGoal) window.appData.goal = elGoal.value;
            const elRate = document.getElementById('pointRate');
            if(elRate) window.appData.rate = elRate.value;

            if (useFirestore && firestoreDocRef) {
                setDoc(firestoreDocRef, window.appData)
                    .catch(e => console.error("Error saving to cloud:", e));
            } else {
                localStorage.setItem('bedrockTracker_v36_core', JSON.stringify(window.appData));
            }
        }

        // --- 2. RENDERERS ---
        window.renderLogTable = function() {
            const tbody = document.getElementById('logTableBody');
            if(!tbody) return;
            const rate = getRate();
            tbody.innerHTML = "";
            if (window.appData.pointsLog && window.appData.pointsLog.length > 0) {
                [...window.appData.pointsLog].reverse().forEach((l,i) => {
                    const val = parseFloat(l.value) || 0;
                    const earn = (val * rate) + (l.externalRevenue||0);
                    const idx = window.appData.pointsLog.length - 1 - i;
                    const safeNote = escapeHtml(l.note||'-');
                    tbody.innerHTML += `<tr><td>${l.date}</td><td style="color:#42b74f">${val}</td><td>${safeNote}</td><td>$${earn.toFixed(4)}</td><td><span class='delete-btn' onclick='deleteLogEntry(${idx})'>[DEL]</span></td></tr>`;
                });
            }
        }

        window.renderGroups = function() {
            const container = document.getElementById('groupsDisplay');
            if(!container) return;
            container.innerHTML = "";
            
            // FEATURE 2 + 5: Calculate Global Total for percentages
            let globalDownloads = 0;
            let maxDiff = -1;
            let bestProjId = "";

            // First pass: Calculate Total and find Best
            GROUP_KEYS.forEach(g => {
                const ps = window.appData.groups[g] || [];
                ps.forEach((p, idx) => {
                    const dl = parseInt(p.downloads) || 0;
                    globalDownloads += dl;
                    if (p.lastDiff > maxDiff) {
                        maxDiff = p.lastDiff;
                        bestProjId = `${g}-${idx}`;
                    }
                });
            });
            
            const totalDlDisp = document.getElementById('totalDownloadsDisplay');
            if (totalDlDisp) totalDlDisp.innerText = globalDownloads.toLocaleString();

            // Second pass: Render
            GROUP_KEYS.forEach(g => {
                const projects = window.appData.groups[g] || [];
                let totalDL = 0; let rows = "";
                
                projects.forEach((p, idx) => {
                    const dl = parseInt(p.downloads) || 0;
                    totalDL += dl;
                    const safeName = escapeHtml(p.name);
                    let diffHtml = (p.lastDiff && p.lastDiff > 0) ? `<span class="growth-indicator">(+${p.lastDiff.toLocaleString()})</span>` : "";
                    
                    const isBest = `${g}-${idx}` === bestProjId && p.lastDiff > 0;
                    const nameClass = isBest ? "top-performer" : "";
                    const badge = isBest ? "üèÜ " : "";

                    rows += `<div class="project-row-display"><span class="${nameClass}">${badge}${safeName}</span><span>${dl.toLocaleString()} ${diffHtml}</span></div>`;
                });

                // FEATURE 5: Group Market Share
                let sharePct = 0;
                if (globalDownloads > 0) sharePct = ((totalDL / globalDownloads) * 100).toFixed(1);

                const color = g === 'A' ? "var(--mc-yellow)" : "#aaa";
                container.innerHTML += `<div class="group-block" style="border-color:${color}"><div style="color:${color}; margin-bottom:5px;">GROUP ${g} <span style="font-size:0.6rem; margin-left:5px;">(${sharePct}%)</span> <span style="float:right; font-size:0.6rem;">${totalDL.toLocaleString()}</span></div>${rows}</div>`;
            });
        }

        window.renderWeek = function() {
            const grid = document.getElementById('weekGrid');
            if(!grid) return;
            grid.innerHTML = '';
            window.appData.currentWeekData.forEach((day, di) => {
                let tasks = "";
                let completedCount = 0;
                day.tasks.forEach((t, ti) => {
                    const done = typeof t === 'object' ? t.done : false;
                    if(done) completedCount++;
                    const text = typeof t === 'object' ? t.text : t;
                    const safeText = escapeHtml(text);
                    tasks += `<div class="task-item ${done?'completed':''}" onclick="toggleTask(${di},${ti})"><div class="mc-checkbox"></div><span>${safeText}</span></div>`;
                });
                
                const totalTasks = day.tasks.length;
                const percent = totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;
                const barHtml = `<div class="task-progress-track"><div class="task-progress-fill" style="width:${percent}%"></div></div>`;

                grid.innerHTML += `<div class="day-card"><div class="day-title">${day.day}</div>${tasks}${barHtml}</div>`;
            });
        }

        window.drawChart = function() {
            const canvas = document.getElementById('growthChart');
            if(!canvas || !canvas.parentElement) return; 
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.parentElement.offsetWidth;
            const h = canvas.height = 320;

            ctx.fillStyle = "#222"; 
            ctx.fillRect(0, 0, w, h);
            
            const logs = (window.appData.pointsLog && window.appData.pointsLog.length > 0) ? window.appData.pointsLog : [];
            if (logs.length === 0) {
                ctx.fillStyle = "#555"; 
                ctx.textAlign="center"; 
                ctx.font = "12px monospace";
                ctx.fillText("NO DATA TO DISPLAY", w/2, h/2);
                return;
            }

            const rate = getRate();
            const cfData = logs.map(l => (parseFloat(l.value || 0) * rate));
            const extData = logs.map(l => parseFloat(l.externalRevenue) || 0);

            const maxVal = Math.max(...cfData, ...extData, 1);
            const padY = 60;
            const padX = 50; 
            const drawH = h - (padY * 2);
            const drawW = w - (padX * 2);
            
            const stepX = logs.length > 1 ? drawW / (logs.length - 1) : 0;

            function getX(i) { return logs.length > 1 ? padX + (i * stepX) : w/2; }
            function getY(val) { return h - padY - ((val / maxVal) * drawH); }

            function drawCurve(data, color, fillStyle, labelDir) {
                if(data.length === 0) return;
                ctx.beginPath();
                ctx.strokeStyle = color; 
                ctx.lineWidth = 4;
                if (data.length === 1) {
                    const x = getX(0); 
                    const y = getY(data[0]);
                    ctx.fillStyle = color; 
                    ctx.beginPath(); 
                    ctx.arc(x, y, 6, 0, Math.PI*2); 
                    ctx.fill();
                } else {
                    ctx.moveTo(getX(0), getY(data[0]));
                    for (let i = 0; i < data.length - 1; i++) {
                        const x1 = getX(i);
                        const y1 = getY(data[i]);
                        const x2 = getX(i+1);
                        const y2 = getY(data[i+1]);
                        const cp1x = x1 + (x2 - x1) / 2;
                        ctx.bezierCurveTo(cp1x, y1, cp1x, y2, x2, y2);
                    }
                    ctx.stroke();
                    ctx.lineTo(getX(data.length - 1), h - padY);
                    ctx.lineTo(getX(0), h - padY);
                    ctx.closePath();
                    const grad = ctx.createLinearGradient(0, padY, 0, h - padY);
                    grad.addColorStop(0, fillStyle);
                    grad.addColorStop(1, "rgba(0,0,0,0)");
                    ctx.fillStyle = grad;
                    ctx.fill();
                }
                data.forEach((val, i) => {
                    const x = getX(i);
                    const y = getY(val);
                    ctx.fillStyle = color;
                    ctx.beginPath(); 
                    ctx.arc(x, y, 5, 0, Math.PI*2); 
                    ctx.fill();
                    ctx.fillStyle = "#fff";
                    ctx.textAlign = "center";
                    ctx.font = "8px 'Press Start 2P'";
                    const offset = labelDir === 1 ? -15 : 25;
                    ctx.fillText("$" + val.toFixed(4), x, y + offset);
                    if (labelDir === 1) {
                        ctx.fillStyle = "#666";
                        ctx.fillText(logs[i].date, x, h - 15);
                    }
                });
            }
            ctx.strokeStyle = "#333";
            ctx.setLineDash([5, 5]);
            for(let i=0; i<logs.length; i++) {
                ctx.beginPath(); 
                ctx.moveTo(getX(i), padY); 
                ctx.lineTo(getX(i), h-padY); 
                ctx.stroke();
            }
            ctx.setLineDash([]);
            drawCurve(cfData, "#42b74f", "rgba(66, 183, 79, 0.3)", 1);
            drawCurve(extData, "#e67e22", "rgba(230, 126, 34, 0.3)", -1);
        }

        // --- 3. CALCULATIONS ---
        window.calculateHistoricalTotals = function() {
            const rate = getRate();
            const now = new Date(); 
            now.setHours(0,0,0,0);
            let sum7 = 0; let prev7 = 0; let sum30 = 0;
            let maxDaily = 0; 

            if (window.appData.pointsLog && window.appData.pointsLog.length > 0) {
                window.appData.pointsLog.forEach(log => {
                    const d = new Date(log.date); 
                    d.setHours(0,0,0,0);
                    const diff = Math.round((now - d) / (1000*60*60*24));
                    const val = (parseFloat(log.value)*rate) + (log.externalRevenue||0);
                    if (val > maxDaily) maxDaily = val; 
                    if(diff >= 0 && diff < 7) sum7 += val;
                    if(diff >= 7 && diff < 14) prev7 += val;
                    if(diff >= 0 && diff < 30) sum30 += val;
                });
            }
            const el7 = document.getElementById('last7TotalDisplay');
            if (el7) el7.innerText = sum7.toFixed(2);
            
            const elBest = document.getElementById('bestDayDisplay');
            if (elBest) elBest.innerText = maxDaily.toFixed(2);
            
            const momEl = document.getElementById('mom7');
            if (momEl) {
                momEl.innerText = sum7 >= prev7 ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è";
                momEl.style.color = sum7 >= prev7 ? "#55ff55" : "#ff5555";
            }
            let lifetime = 0;
            if (window.appData.pointsLog && window.appData.pointsLog.length > 0) {
                lifetime = window.appData.pointsLog.reduce((a,b) => a + (parseFloat(b.value)*rate) + (b.externalRevenue||0), 0);
            }
            const elLife = document.getElementById('lifetimeDisplay');
            if (elLife) elLife.innerText = lifetime.toFixed(2);

            // FEATURE 2: Update Boss Bar (Next $100 Milestone)
            const nextMilestone = Math.ceil((lifetime + 0.01) / 100) * 100;
            const prevMilestone = nextMilestone - 100;
            const progress = lifetime - prevMilestone;
            const pct = Math.min((progress / 100) * 100, 100);
            
            const bossFill = document.getElementById('bossBarFill');
            const bossText = document.getElementById('bossBarText');
            if (bossFill) bossFill.style.width = pct + "%";
            if (bossText) bossText.innerText = `NEXT MILESTONE: $${nextMilestone} (${pct.toFixed(1)}%)`;
            
            if(window.appData.pointsLog && window.appData.pointsLog.length > 0) {
                 const recent = window.appData.pointsLog.slice(-7);
                 let recentSum = 0;
                 recent.forEach(l => recentSum += (parseFloat(l.value)*rate)+(l.externalRevenue||0));
                 const avg = recentSum/recent.length;
                 
                 const elDays = document.getElementById('daysToGoalDisplay');
                 if (elDays) {
                    if (avg > 0) {
                        const remaining = 200 - lifetime;
                        if (remaining <= 0) {
                             elDays.innerText = "DONE!";
                             elDays.style.color = "var(--mc-green)";
                        } else {
                             const days = Math.ceil(remaining / avg);
                             elDays.innerText = days + " Days";
                             elDays.style.color = "var(--mc-red)";
                        }
                    } else {
                        elDays.innerText = "N/A";
                    }
                 }
            }
        }

        window.updateRevenue = function() {
            const ptsInput = document.getElementById('currentPoints');
            const ptsVal = ptsInput ? ptsInput.value.replace(/,/g, '.') : "0";
            const pts = parseFloat(ptsVal) || 0;
            const rate = getRate();
            let extTotal = 0;
            if (window.appData.revenueSources && window.appData.revenueSources.length > 0) {
                window.appData.revenueSources.forEach(s => extTotal += parseFloat(s.val)||0);
            }
            const gross = (pts * rate) + extTotal;
            const revDisp = document.getElementById('revenueDisplay');
            if (revDisp) revDisp.innerText = gross.toFixed(4);
            const revHubCF = document.getElementById('revHubCF');
            if (revHubCF) revHubCF.innerText = "$" + (pts * rate).toFixed(4);
            const revHubTotal = document.getElementById('revHubTotal');
            if (revHubTotal) revHubTotal.innerText = gross.toFixed(4);
            
            const goalVal = parseFloat(window.appData.goal) || 120;
            const currentPointsTotal = pts + (extTotal / rate);
            const pct = Math.min((currentPointsTotal / goalVal) * 100, 100);
            const meterFill = document.getElementById('goalMeterFill');
            const meterText = document.getElementById('goalMeterText');
            if(meterFill) meterFill.style.width = pct + "%";
            if(meterText) meterText.innerText = `${Math.floor(pct)}% of Daily Goal`;

            saveData();
            calculateHistoricalTotals();
            renderLogTable(); 
            drawChart();
        }

        window.refreshAll = function() {
            // Apply Theme
            if (window.appData.theme === "nether") {
                document.body.classList.add('nether-theme');
            } else {
                document.body.classList.remove('nether-theme');
            }

            updateRevenue(); 
            renderGroups(); 
            renderWeek();
            const streakVal = document.getElementById('streakValue');
            if (streakVal) streakVal.innerText = window.appData.streak || 0;
            
            // FEATURE 1: Init Splash Text
            const splashes = [
                "Also try Terraria!", "Track those stats!", "Don't dig down!",
                "Creeper? Aww man!", "Bedrock Edition!", "Road to $200!",
                "Update your addons!", "Check your comments!", "Fix that bug!",
                "Behavior Packs Rule!", "Resource Packs too!", "Stay Blocky!"
            ];
            const splashEl = document.getElementById('splashText');
            if(splashEl) splashEl.innerText = splashes[Math.floor(Math.random() * splashes.length)];

            // UI Sync: Points
            const elP = document.getElementById('currentPoints');
            if (elP) elP.value = window.appData.points || 18;
            const elG = document.getElementById('goalPoints');
            if (elG) elG.value = window.appData.goal || 120;
            const elR = document.getElementById('pointRate');
            if (elR) elR.value = window.appData.rate || 0.05;
        }

        // --- 4. HANDLERS ---
        window.toggleTheme = function() {
            if (window.appData.theme === "nether") {
                window.appData.theme = "normal";
            } else {
                window.appData.theme = "nether";
            }
            saveData();
            refreshAll();
        };

        // FEATURE 4: Toggle Focus Mode
        window.toggleFocus = function() {
            const chart = document.getElementById('chartSection');
            if (chart) {
                chart.style.display = chart.style.display === 'none' ? 'block' : 'none';
            }
        };

        // FEATURE 3: Quick Add
        window.addPoints = function(amount) {
            const el = document.getElementById('currentPoints');
            if (el) {
                let val = parseFloat(el.value) || 0;
                val += amount;
                el.value = val;
                updateRevenue(); // Triggers save and UI update
            }
        };

        window.copyDailyReport = function() {
            const date = getTodayString();
            const pts = document.getElementById('currentPoints').value;
            const earn = document.getElementById('revenueDisplay').innerText;
            const streak = window.appData.streak || 0;
            const goal = window.appData.goal || 120;
            const pct = Math.floor((parseFloat(pts)/parseFloat(goal))*100);
            
            const report = `üìä **Daily Report: ${date}**\nüí∞ Earnings: $${earn}\nüéØ Goal: ${pct}%\nüî• Streak: ${streak} Days\nüõ†Ô∏è #BedrockDev`;
            
            const el = document.createElement('textarea');
            el.value = report;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("COPIED TO CLIPBOARD:\n" + report);
        };

        window.logPoints = function() {
            const elPts = document.getElementById('currentPoints');
            const elNote = document.getElementById('logNote');
            
            let currentValString = elPts ? elPts.value : "0";
            currentValString = currentValString.replace(/,/g, '.');
            const current = parseFloat(currentValString) || 0;

            const note = elNote ? elNote.value : "";
            const todayStr = getTodayString();
            
            if (window.appData.lastLoginDate !== todayStr) {
                 const last = window.appData.lastLoginDate ? new Date(window.appData.lastLoginDate) : null;
                 if (last) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toLocaleDateString('en-US');
                    if (window.appData.lastLoginDate === yesterdayStr) {
                         window.appData.streak = (window.appData.streak || 0) + 1;
                    } else {
                         window.appData.streak = 1; 
                    }
                 } else {
                    window.appData.streak = 1;
                 }
                 window.appData.lastLoginDate = todayStr;
            }

            let ext = 0; 
            if (window.appData.revenueSources && window.appData.revenueSources.length > 0) {
                window.appData.revenueSources.forEach(s => ext += parseFloat(s.val)||0);
            }
            
            if (!window.appData.pointsLog) window.appData.pointsLog = [];
            window.appData.pointsLog.push({date: todayStr, value:current, note, externalRevenue:ext});
            if(window.appData.pointsLog.length > 30) window.appData.pointsLog.shift();
            if (elNote) elNote.value = "";
            
            updateRevenue(); 
            refreshAll(); 
            alert("Logged: " + current);
        }

        window.deleteLogEntry = function(index) { 
            if(confirm("Delete?")) { 
                if (window.appData.pointsLog && index >= 0 && index < window.appData.pointsLog.length) {
                    window.appData.pointsLog.splice(index, 1); 
                    saveData();
                    refreshAll(); 
                }
            } 
        }
        
        window.saveGoal = function() { saveData(); drawChart(); updateRevenue(); } 
        window.toggleLogTable = () => { 
            const el=document.getElementById('logTableContainer'); 
            if(el) el.style.display = el.style.display==='none'?'block':'none'; 
        }
        window.toggleUtility = () => { 
            const el=document.getElementById('utilityTool'); 
            if(el) el.style.display=el.style.display==='none'?'grid':'none'; 
        }
        window.openRevenueHub = () => {
             const c = document.getElementById('revSourcesContainer'); 
             if(!c) return;
             c.innerHTML="";
             if (!window.appData.revenueSources) {
                 window.appData.revenueSources = [{name:"Adsterra", val:0}, {name:"YouTube", val:0}];
             }
             window.appData.revenueSources.forEach((s,i) => {
                 c.innerHTML += `<div class='rev-row'><span>${escapeHtml(s.name)}</span><input type='number' class='rev-input' value='${s.val}' onchange='window.appData.revenueSources[${i}].val=parseFloat(this.value)||0; updateRevenue();'></div>`;
             });
             document.getElementById('revenueHubModal').style.display='flex';
             updateRevenue();
        };
        window.saveRevenueHub = () => { 
            document.getElementById('revenueHubModal').style.display='none'; 
            saveData();
            updateRevenue(); 
        };
        window.addRevenueSource = () => { 
            const n = prompt("Name:"); 
            if(n) { 
                if (!window.appData.revenueSources) window.appData.revenueSources = [];
                window.appData.revenueSources.push({name:n, val:0}); 
                window.openRevenueHub(); 
            } 
        };
        window.resetInactivityTimer = () => { 
            window.appData.lastCFLogin = getTodayString(); 
            saveData(); 
            alert("Reset!"); 
        };
        window.openEditGroups = () => { 
            document.getElementById('editGroupsModal').style.display='flex'; 
            window.renderEditModalContent(); 
        };
        
        window.renderEditModalContent = function() {
            window.tempGroups = {
                A: window.appData.groups.A ? JSON.parse(JSON.stringify(window.appData.groups.A)) : [],
                B: window.appData.groups.B ? JSON.parse(JSON.stringify(window.appData.groups.B)) : [],
                C: window.appData.groups.C ? JSON.parse(JSON.stringify(window.appData.groups.C)) : [],
                D: window.appData.groups.D ? JSON.parse(JSON.stringify(window.appData.groups.D)) : [],
                E: window.appData.groups.E ? JSON.parse(JSON.stringify(window.appData.groups.E)) : [],
                F: window.appData.groups.F ? JSON.parse(JSON.stringify(window.appData.groups.F)) : []
            };
            const c = document.getElementById('groupEditContainer'); 
            if(!c) return;
            c.innerHTML="";
            GROUP_KEYS.forEach(g => {
                 const d = document.createElement('div');
                 d.innerHTML = `<div style="margin-bottom:5px; color:#aaa;">GROUP ${g}</div>`;
                 if (window.tempGroups[g] && window.tempGroups[g].length > 0) {
                     window.tempGroups[g].forEach((p,i) => {
                         const safeName = escapeHtml(p.name);
                         d.innerHTML += `<div class='project-edit-row'><input class='proj-name-input' value="${safeName}" onchange="window.tempGroups['${g}'][${i}].name=this.value"><input type='number' class='proj-dl-input' value="${p.downloads || 0}" onchange="window.tempGroups['${g}'][${i}].downloads=this.value"><div class='proj-del-btn' onclick="window.tempGroups['${g}'].splice(${i},1);window.renderEditModalContent();">X</div></div>`;
                     });
                 }
                 d.innerHTML += `<div class='add-proj-btn' onclick="window.tempGroups['${g}'].push({name:'New',downloads:0,lastDiff:0});window.renderEditModalContent();">+ ADD</div>`;
                 c.appendChild(d);
            });
        }
        window.saveGroups = () => {
             GROUP_KEYS.forEach(g => {
                 if (!window.appData.groups[g]) window.appData.groups[g] = [];
                 if (!window.tempGroups[g]) window.tempGroups[g] = [];
                 window.tempGroups[g].forEach(np => {
                     const op = window.appData.groups[g].find(x => x.name === np.name);
                     if(op) {
                         np.lastDiff = parseInt(np.downloads || 0) - parseInt(op.downloads || 0);
                     } else {
                         np.lastDiff = 0;
                     }
                 });
             });
             window.appData.groups = window.tempGroups; 
             saveData(); 
             renderGroups(); 
             document.getElementById('editGroupsModal').style.display='none';
        };

        window.openCFPasteModal = () => document.getElementById('cfPasteModal').style.display='flex';
        window.copyScraperScript = () => {
             const s = `(function() {
    let projects = [];
    let rows = document.querySelectorAll('table tbody tr');
    if (rows.length === 0) rows = document.querySelectorAll('.project-listing-row, .project-card');

    rows.forEach(row => {
        let nameEl = row.querySelector('.project-name, .name h3, h3, .project-title');
        if (!nameEl) {
            let links = row.querySelectorAll('a');
            for(let link of links) {
                let txt = link.innerText.trim();
                if (txt.length > 1 && txt !== "Edit" && txt !== "Manage" && txt !== "Delete" && txt !== "View") {
                    nameEl = link;
                    break;
                }
            }
        }
        let dlText = "0";
        let dlEl = row.querySelector('.downloads, .download-count');
        if (dlEl) {
            dlText = dlEl.innerText;
        } else {
            let cells = row.querySelectorAll('td, span');
            for (let cell of cells) {
                let txt = cell.innerText.trim();
                if (txt.match(/^[\\d,.]+[kKmM]?$/) && !txt.includes('/') && !txt.includes(':')) {
                    dlText = txt;
                }
            }
        }
        if (nameEl) {
            let name = nameEl.innerText.trim();
            if (name === "Edit") return;
            let raw = dlText.toLowerCase().replace(/,/g, '').replace('downloads','').trim();
            let multiplier = 1;
            if (raw.includes('k')) { multiplier = 1000; raw = raw.replace('k', ''); }
            if (raw.includes('m')) { multiplier = 1000000; raw = raw.replace('m', ''); }
            let count = parseFloat(raw) * multiplier;
            if (!isNaN(count) && count > 0) {
                projects.push({ name: name, downloads: count });
            }
        }
    });

    if(projects.length > 0) {
        const jsonOutput = JSON.stringify(projects);
        console.log("‚úÖ FIXED LIST:");
        console.log(jsonOutput);
        const el = document.createElement('textarea');
        el.value = jsonOutput;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        alert("SUCCESS! Copied " + projects.length + " projects with correct names.\\nGo paste it in your Tracker now.");
    } else {
        alert("‚ùå No projects found. Ensure you are on the 'My Projects' list page.");
    }
})();`;
             const textArea = document.createElement("textarea");
             textArea.value = s;
             document.body.appendChild(textArea);
             textArea.select();
             document.execCommand('copy');
             document.body.removeChild(textArea);
             alert("SCRAPER SCRIPT COPIED!");
        };

        window.processCFPaste = () => {
             try {
                 const arr = JSON.parse(document.getElementById('cfPasteArea').value);
                 if (!Array.isArray(arr)) throw new Error("Invalid data format");
                 
                 arr.sort((a,b)=>(b.downloads||0)-(a.downloads||0));
                 
                 // UPDATED: Distribution logic for 6 groups (A-F)
                 window.appData.groups.A = arr.slice(0,4).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 window.appData.groups.B = arr.slice(4,8).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 window.appData.groups.C = arr.slice(8,12).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 window.appData.groups.D = arr.slice(12,16).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 window.appData.groups.E = arr.slice(16,20).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 window.appData.groups.F = arr.slice(20).map(x=>({name: x.name, downloads: x.downloads, lastDiff:0}));
                 
                 saveData(); 
                 refreshAll(); 
                 document.getElementById('cfPasteModal').style.display='none';
                 alert("Projects imported successfully into Groups A-F!");
             } catch(e) { 
                 alert("Invalid JSON format. Please paste valid data."); 
                 console.error(e);
             }
        };

        window.toggleTask = (di, ti) => {
            if (!window.appData.currentWeekData[di] || !window.appData.currentWeekData[di].tasks[ti]) return;
            let t = window.appData.currentWeekData[di].tasks[ti];
            if(typeof t === 'string') {
                window.appData.currentWeekData[di].tasks[ti] = {text: t, done: true};
            } else {
                t.done = !t.done;
            }
            saveData(); 
            renderWeek();
        };

        window.archiveAndReset = () => {
            if(!confirm("Archive this week and start fresh?")) return;
            window.appData.currentWeekData.forEach(day => {
                day.tasks = day.tasks.map(t => {
                    if (typeof t === 'object') return t.text;
                    return t;
                });
            });
            saveData(); 
            location.reload();
        }

        window.exportData = () => { 
            const b=new Blob([JSON.stringify(window.appData, null, 2)],{type:'application/json'}); 
            const u=URL.createObjectURL(b); 
            const a=document.createElement('a'); 
            a.href=u; 
            a.download='tracker_backup_' + new Date().toISOString().split('T')[0] + '.json'; 
            a.click(); 
            URL.revokeObjectURL(u);
        }

        // FEATURE 5: CSV Export
        window.exportCSV = () => {
            let csvContent = "data:text/csv;charset=utf-8,Date,Points,Note,External Revenue,Total Earnings\n";
            const rate = getRate();
            if (window.appData.pointsLog) {
                window.appData.pointsLog.forEach(row => {
                    const p = parseFloat(row.value) || 0;
                    const ext = parseFloat(row.externalRevenue) || 0;
                    const total = (p * rate) + ext;
                    // Escape note to prevent CSV breakage
                    const safeNote = (row.note || "").replace(/,/g, " ");
                    csvContent += `${row.date},${p},${safeNote},${ext},${total.toFixed(4)}\n`;
                });
            }
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "tracker_data_" + new Date().toISOString().split('T')[0] + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        window.importData = function() {
            const f = document.getElementById('importFile').files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (e) => { 
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported && typeof imported === 'object') {
                        window.appData = { ...window.appData, ...imported };
                        if (!window.appData.pointsLog) window.appData.pointsLog = [];
                        if (!window.appData.revenueSources) window.appData.revenueSources = [];
                        if (!window.appData.groups) window.appData.groups = { A: [], B: [], C: [], D: [], E: [], F: [] };
                        saveData(); 
                        location.reload();
                    } else {
                        throw new Error("Invalid file format");
                    }
                } catch(err) {
                    alert("Error importing file: " + err.message);
                }
            };
            r.readAsText(f);
        }

        window.confirmAudit = function() {
             GROUP_KEYS.forEach(g => {
                 if (!window.appData.groups[g]) window.appData.groups[g] = [];
                 window.appData.groups[g].forEach((p,i) => {
                     const el = document.getElementById(`audit-${g}-${i}`);
                     if (el && el.value) {
                         const valStr = el.value.replace(/,/g,'');
                         const newVal = parseInt(valStr) || 0;
                         p.lastDiff = newVal - (parseInt(p.downloads) || 0);
                         p.downloads = newVal;
                     }
                 });
             });
             window.appData.lastAuditDate = getTodayString();
             saveData(); 
             refreshAll(); 
             document.getElementById('weeklyAuditModal').style.display='none';
        }

        // --- 5. APP INITIALIZATION (FIREBASE + LOCAL FALLBACK) ---
        function initApp() {
            // Setup Clock
            setInterval(() => { 
                const clock = document.getElementById('clockDisplay');
                if (clock) {
                    const now = new Date();
                    clock.innerText = now.toLocaleString('en-US', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'
                    }); 
                }
            }, 1000);

            // Audit Check
            const lastAudit = window.appData.lastAuditDate ? new Date(window.appData.lastAuditDate) : new Date(0);
            const diff = (new Date() - lastAudit)/(1000*60*60*24);
            if(diff > 7) {
                const c = document.getElementById('auditContainer'); 
                if (c) {
                    c.innerHTML="";
                    let hasProjects = false;
                    GROUP_KEYS.forEach(g => {
                        if(window.appData.groups[g] && window.appData.groups[g].length > 0) {
                            hasProjects = true;
                            c.innerHTML += `<div style="color:var(--mc-yellow); margin-top:10px;">GROUP ${g}</div>`;
                            window.appData.groups[g].forEach((p,i) => {
                                c.innerHTML += `<div class='stat-input-row'><span>${escapeHtml(p.name)}</span><input type='number' id='audit-${g}-${i}' value='${p.downloads || 0}'></div>`;
                            });
                        }
                    });
                    if (hasProjects) {
                        const auditModal = document.getElementById('weeklyAuditModal');
                        if (auditModal) setTimeout(() => { auditModal.style.display='flex'; }, 1000);
                    }
                }
            }
        }

        // Firebase Setup
        try {
            if (typeof __firebase_config !== 'undefined') {
                useFirestore = true;
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // AUTH + SNAPSHOT
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();

                onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        user = currentUser;
                        firestoreDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'tracker_core');
                        
                        // Listen for Realtime Updates
                        onSnapshot(firestoreDocRef, (snapshot) => {
                            if (snapshot.exists()) {
                                // Cloud has data -> Load it
                                window.appData = { ...window.appData, ...snapshot.data() };
                                refreshAll();
                            } else {
                                // Cloud is empty -> Check LocalStorage for migration
                                const savedLocal = localStorage.getItem('bedrockTracker_v36_core');
                                if (savedLocal) {
                                    try {
                                        const parsed = JSON.parse(savedLocal);
                                        window.appData = { ...window.appData, ...parsed };
                                        console.log("Migrating LocalStorage to Firestore...");
                                        // Save immediately to Cloud
                                        setDoc(firestoreDocRef, window.appData);
                                    } catch(e) { console.error(e); }
                                } else {
                                    // New User -> Initialize Cloud
                                    setDoc(firestoreDocRef, window.appData);
                                }
                                refreshAll();
                            }
                        });
                    }
                });
            } else {
                throw new Error("No config");
            }
        } catch (e) {
            console.log("Running in Local Mode (LocalStorage)");
            useFirestore = false;
            const saved = localStorage.getItem('bedrockTracker_v36_core');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    window.appData = { ...window.appData, ...parsed };
                } catch(e) {}
            }
            refreshAll();
        }

        initApp(); // Run UI helpers

    </script>
</body>
</html>
